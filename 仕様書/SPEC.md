# Dashcam 仕様書（完成版・最終確定）

---

## 1. 目的

Raspberry Pi 5 上で以下の機能を統合的に提供するダッシュカム／計測可視化システムを構築する。

- カメラモジュール V3（広角）×2  
  - プレビュー表示（MJPEG）
  - 静止画撮影
  - 露出補正（EV）
  - **最高画質での動画撮影（開始／停止）**
- LED ×2 系統の PWM 制御
- 磁気センサによる方位角計測（水平設置前提）
- 距離センサによる距離計測（単位：m）
- 温湿度センサによる外気／筐体内の温湿度計測
- 記録モード時の **センサ別 CSV 保存（開始／終了制御）**
- 保存データ（画像・動画・CSV）を Web UI から参照・ダウンロード
- UI からの **設定・キャリブレーション操作**

---

## 2. システム構成

### サービス構成（責務分離）

#### UI_service
- Web UI（HTML / CSS / JavaScript）配信
- camera_service / sensor_service の API を呼び出すフロントエンド
- sensor_service の SSE を購読して画面更新
- 記録継続警告ポップアップの表示
- 設定画面（config編集／キャリブレーション操作）

#### camera_service
- cam0 / cam1 プレビュー（MJPEG）
- 静止画撮影
- 最高画質動画撮影（開始／停止）
- LED 制御
- **UI の静的配信は行わない**

#### sensor_service
- 磁気・距離・温湿度センサ計測
- SSE 配信（UI 向け）
- 記録モード制御（開始／終了）
- センサ別 CSV 出力
- 記録継続時間監視・警告イベント発行
- クラッシュ／再起動時の記録回収
- ファイルビュワー（画像・動画・CSV の一覧／DL）
- 設定反映・キャリブレーション管理

---

## 3. UI 仕様

### 3.1 UI 構成

UI は以下の 3 セクションで構成する。

#### Camera Section
- CAM0 / CAM1 プレビュー
- 全画面表示
- 静止画撮影（Shot）
- EV スライダー（カメラ別）
- 動画撮影（REC / STOP）
- 録画状態・経過時間表示

#### LED Section
- LED1 / LED2  
  - ON / OFF  
  - 明るさスライダー（0–100%）

#### Sensor Section
- Heading（方位）：円形コンパス HUD、数値表示（deg）
- Distance（距離）：距離数値（m）、ステータス色分け、履歴グラフ
- Temperature（温湿度）：外気／筐体内色分け、閾値警告

### 3.2 設定画面（UI下部ボタン）
- UI 下部に **設定ボタン**を常設
- 押下で設定画面（`/settings`）を表示

---

## 4. カメラ仕様（camera_service）

- CSI ポート若番＝cam0、次番＝cam1
- MJPEG 1536×864 / 15fps
- 静止画・動画は設定ディレクトリへ保存
- LED はフェイルセーフ動作（起動時 PWM=0）

---

## 5. センサ仕様（sensor_service）

- 磁気：MMC5983MA（水平設置）
- 距離：TSD10（m）
- 温湿度：SHT31 ×2（PCA9546）

---

## 6. 磁気センサキャリブレーション（単一ファイル）

- 保存先：
```
<calibration_dir>/magnetometer_calibration.json
```
- 履歴管理なし、上書き保存
- 起動時自動適用

---

## 7. 記録モード（CSV）

- sensor_service が制御
- `<sensor>_<start>_OPEN.csv` → `<sensor>_<start>_<end>.csv`

---

## 8. 記録継続警告

- 初回 + 一定間隔で繰り返し警告
- Continue / Stop 選択
- 未選択時は継続

---

## 9. クラッシュ耐性

- append-only CSV
- 起動時自動回収

---

## 10. ファイルビュワー

- 画像・動画・CSV を Web から DL

---

## 11. 設定ファイル

- 周期・閾値・GPIO・保存先・警告条件

---

## 12. 仕様確定ポイント

- 責務分離
- 高耐障害
- 現場運用向け
